# System Patterns: Simple Blog Engine

## Архитектура системы

Simple Blog Engine построен на модульной архитектуре с четким разделением ответственности между компонентами.

### Общая структура

```
                    +-------------------+
                    |     CLI Layer     |
                    |(blog-engine.js)   |
                    +---------+---------+
                              |
                              v
+----------------+   +-------------------+   +---------------+
| Configuration  |<->|   Core Engine    |<->|  File System  |
| (config.json)  |   |(index.js)        |   |(content files)|
+----------------+   +---------+---------+   +---------------+
                              |
          +------------------++-----------------+
          |                  |                  |
          v                  v                  v
+-------------------+ +----------------+ +------------------+
| Content Processing| | Template Engine| | Site Generation  |
|(markdownProcessor)| |(templateEngine)| |(siteBuilder)     |
+-------------------+ +----------------+ +------------------+
```

### Ключевые компоненты

1. **CLI Layer** (bin/blog-engine.js): 
   - Отвечает за взаимодействие с пользователем через командную строку
   - Преобразует команды в вызовы ядра движка
   - Обеспечивает интерактивность при создании новых постов

2. **Core Engine** (lib/index.js):
   - Центральный модуль, координирующий работу всех компонентов
   - Экспортирует API для CLI и внешних приложений
   - Управляет процессом инициализации и сборки

3. **Content Processing** (lib/markdownProcessor.js):
   - Обработка Markdown в HTML
   - Извлечение метаданных из frontmatter
   - Расчет времени чтения и других метрик

4. **Template Engine** (lib/templateEngine.js):
   - Рендеринг HTML-шаблонов
   - Поддержка языка шаблонов с переменными и условиями
   - Обработка частичных шаблонов (partials)

5. **Site Generation** (lib/siteBuilder.js):
   - Создание итоговой структуры сайта
   - Генерация страниц категорий, тегов и индексов
   - Копирование статических ресурсов

## Потоки данных

### Процесс инициализации блога

1. CLI получает команду `init`
2. Создает директории для контента и шаблонов
3. Копирует шаблоны по умолчанию и конфигурационные файлы
4. Создает базовые примеры контента
5. Устанавливает зависимости и настраивает скрипты npm

### Процесс создания поста

1. CLI получает команду `new` с названием поста
2. Генерирует slug из названия с помощью транслитерации
3. Создает файл Markdown с базовым frontmatter
4. Сохраняет файл в директории контента

### Процесс сборки сайта

1. Чтение конфигурации из config.json
2. Загрузка всех Markdown-файлов контента
3. Разбор frontmatter и преобразование Markdown в HTML
4. Загрузка и обработка шаблонов
5. Генерация HTML-страниц для каждого поста
6. Создание индексных страниц, страниц тегов и категорий
7. Копирование статических ресурсов (CSS, JS, изображения)
8. Генерация дополнительных файлов (sitemap, RSS, Telegram IV Template)

### Процесс разработки (serve)

1. Запуск процесса сборки
2. Запуск локального HTTP-сервера для предпросмотра
3. Установка отслеживания файлов для автоматической пересборки
4. Обновление браузера при изменениях (hot reload)

## Интерфейсы компонентов

### Основной API ядра (lib/index.js)

```javascript
// Инициализация нового блога
initialize(targetDir, options)

// Сборка статического сайта
build(options)

// Запуск сервера разработки
serve(options)

// Создание нового поста
createPost(title, options)
```

### Интерфейс обработки Markdown (lib/markdownProcessor.js)

```javascript
// Преобразование Markdown в HTML
processMarkdown(markdownContent)

// Извлечение и обработка frontmatter
extractFrontmatter(content)

// Расчет времени чтения
calculateReadingTime(content, wordsPerMinute)
```

### Интерфейс шаблонизатора (lib/templateEngine.js)

```javascript
// Регистрация шаблона
registerTemplate(name, content)

// Рендеринг шаблона с данными
renderTemplate(name, data)

// Регистрация хелперов/функций для шаблонов
registerHelper(name, fn)
```

## Шаблоны проектирования

1. **Модуль (Module Pattern)**:
   - Изолированные компоненты с четкими интерфейсами
   - Скрытие внутренней реализации
   - Пример: каждый файл в lib/ предоставляет модульный API

2. **Фасад (Facade Pattern)**:
   - Упрощенный высокоуровневый интерфейс для сложной подсистемы
   - Пример: index.js предоставляет простой API для всей системы

3. **Стратегия (Strategy Pattern)**:
   - Разные стратегии генерации HTML/CSS
   - Возможность переключения рендереров Markdown
   - Пример: configManager поддерживает разные способы чтения конфигурации

4. **Наблюдатель (Observer Pattern)**:
   - Используется в режиме разработки для отслеживания изменений файлов
   - Реагирование на изменения без активного опроса
   - Пример: отслеживание изменений в файлах при запуске dev-сервера

5. **Компоновщик (Composite Pattern)**:
   - Древовидная структура для контента и шаблонов
   - Возможность работы с отдельными элементами и группами одинаково
   - Пример: организация постов и категорий

## Технические решения

1. **Разделение движка и контента**:
   - Движок в виде npm-пакета
   - Контент в отдельной директории, не затрагиваемой при обновлении
   - Возможность использования Git для контроля версий контента

2. **Двойной CLI-интерфейс**:
   - Поддержка коротких `blog-engine` и полных `simple-blog-engine` команд
   - Единая кодовая база для обоих интерфейсов

3. **Интеграция с GitHub Pages**:
   - Автоматическое создание конфигурации для GitHub Actions
   - Оптимизация для публикации на GitHub Pages

4. **CSS-переменные для легкой кастомизации**:
   - Динамическая генерация CSS на основе конфигурации
   - Поддержка темной/светлой темы

5. **Оптимизация для социальных сетей**:
   - Автоматическая генерация метатегов OpenGraph
   - Шаблон Telegram Instant View

## Ограничения и технический долг

1. **Ограниченный функционал шаблонизатора**:
   - Базовый синтаксис без продвинутых функций
   - Потенциальное улучшение: поддержка более мощных шаблонизаторов

2. **Отсутствие плагинной системы**:
   - Ограниченные возможности для расширения без изменения основного кода
   - Потенциальное улучшение: API для плагинов

3. **Необходимость Node.js окружения**:
   - Зависимость от Node.js для работы CLI
   - Потенциальное улучшение: бинарные сборки для разных платформ 